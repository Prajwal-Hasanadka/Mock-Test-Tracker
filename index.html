<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Mock Test Tracker (PCM)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
        }
        /* Style for the table header to ensure proper alignment and appearance */
        th {
            text-align: left;
        }
        /* Basic table styling for better readability */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0; /* Light gray border */
        }
        /* Styling for loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1; /* Indigo-600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-700 mb-8">Weekly Mock Test Tracker (Physics, Chemistry, Mathematics)</h1>

        <!-- Navigation Buttons -->
        <nav class="mb-8 flex justify-center space-x-6">
            <button id="homeNavBtn"
                    class="px-5 py-2 rounded-md text-lg font-medium transition duration-150 ease-in-out
                           bg-indigo-600 text-white shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Home
            </button>
            <button id="chartNavBtn"
                    class="px-5 py-2 rounded-md text-lg font-medium transition duration-150 ease-in-out
                           bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Charts
            </button>
        </nav>

        <!-- User ID Display and Loading Message -->
        <div class="text-center mb-6">
            <p id="userIdDisplay" class="text-sm text-gray-600 mb-2">Authenticating...</p>
            <div id="loadingMessage" class="flex items-center justify-center text-indigo-600 text-lg font-medium">
                <div class="spinner mr-3"></div>
                Loading data...
            </div>
            <!-- New Google Sign-In Button -->
            <button id="googleSignInBtn"
                    class="mt-4 inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h6.16c-.23 1.12-.85 2.07-1.77 2.71v2.79h3.58c2.09-1.93 3.3-4.78 3.3-8.01z" fill="#4285F4"/>
                    <path d="M12 23c3.24 0 5.95-1.08 7.93-2.93l-3.58-2.79c-.93.64-1.97 1.01-3.21 1.01-2.47 0-4.56-1.66-5.33-3.88H2.93v2.79C4.91 21.92 8.25 23 12 23z" fill="#34A853"/>
                    <path d="M6.67 14.07c-.1-.32-.16-.65-.16-1.01s.06-.69.16-1.01V9.27H2.93c-.64 1.25-.99 2.64-.99 4.09s.35 2.84.99 4.09h3.74V14.07z" fill="#FBBC05"/>
                    <path d="M12 5.86c1.77 0 3.34.61 4.59 1.79l3.19-3.19C17.95 1.08 15.24 0 12 0 8.25 0 4.91 1.08 2.93 3.08l3.74 2.91c.77-2.22 2.86-3.88 5.33-3.88z" fill="#EA4335"/>
                </svg>
                Sign in with Google
            </button>
            <button id="signOutBtn"
                    class="mt-4 ml-2 inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-gray-700 bg-gray-300 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out hidden">
                Sign Out
            </button>
        </div>

        <!-- Home Section: Form and Table -->
        <div id="homeSection">
            <!-- Form to Add New Test Results -->
            <div class="mb-8 p-6 bg-indigo-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-indigo-600 mb-5">Add New Test Result</h2>
                <form id="testForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Test Date -->
                    <div>
                        <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">Test Date</label>
                        <input type="date" id="testDate" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Test Name/ID -->
                    <div>
                        <label for="testName" class="block text-sm font-medium text-gray-700 mb-1">Test Name/ID</label>
                        <input type="text" id="testName" placeholder="e.g., JEE Mock 1" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Max Marks -->
                    <div>
                        <label for="maxMarks" class="block text-sm font-medium text-gray-700 mb-1">Max Marks</label>
                        <input type="number" id="maxMarks" placeholder="e.g., 300" required min="1"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Your Total Score -->
                    <div>
                        <label for="yourScore" class="block text-sm font-medium text-gray-700 mb-1">Your Total Score</label>
                        <input type="number" id="yourScore" placeholder="e.g., 180" required min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Rank (Optional) -->
                    <div>
                        <label for="rank" class="block text-sm font-medium text-gray-700 mb-1">Rank (Optional)</label>
                        <input type="number" id="rank" placeholder="e.g., 12" min="1"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Time Taken (Minutes) -->
                    <div>
                        <label for="timeTaken" class="block text-sm font-medium text-gray-700 mb-1">Time Taken (Minutes)</label>
                        <input type="number" id="timeTaken" placeholder="e.g., 180" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Physics Score -->
                    <div>
                        <label for="physicsScore" class="block text-sm font-medium text-gray-700 mb-1">Physics Score</label>
                        <input type="number" id="physicsScore" placeholder="e.g., 60" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Chemistry Score -->
                    <div>
                        <label for="chemistryScore" class="block text-sm font-medium text-gray-700 mb-1">Chemistry Score</label>
                        <input type="number" id="chemistryScore" placeholder="e.g., 55" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Mathematics Score -->
                    <div>
                        <label for="mathScore" class="block text-sm font-medium text-gray-700 mb-1">Mathematics Score</label>
                        <input type="number" id="mathScore" placeholder="e.g., 65" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Total Questions -->
                    <div>
                        <label for="totalQuestions" class="block text-sm font-medium text-gray-700 mb-1">Total Questions</label>
                        <input type="number" id="totalQuestions" placeholder="e.g., 75" min="1"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Correct Answers -->
                    <div>
                        <label for="correctAnswers" class="block text-sm font-medium text-gray-700 mb-1">Correct Answers</label>
                        <input type="number" id="correctAnswers" placeholder="e.g., 50" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Incorrect Answers -->
                    <div>
                        <label for="incorrectAnswers" class="block text-sm font-medium text-gray-700 mb-1">Incorrect Answers</label>
                        <input type="number" id="incorrectAnswers" placeholder="e.g., 15" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Unattempted Questions -->
                    <div>
                        <label for="unattemptedQuestions" class="block text-sm font-medium text-gray-700 mb-1">Unattempted Questions</label>
                        <input type="number" id="unattemptedQuestions" placeholder="e.g., 10" min="0"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <!-- Remarks/Areas for Improvement -->
                    <div class="lg:col-span-3">
                        <label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">Remarks/Areas for Improvement</label>
                        <textarea id="remarks" rows="3" placeholder="e.g., Need to improve speed in Physics, revise Chemical Bonding."
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div class="lg:col-span-3 flex justify-end">
                        <button type="submit"
                                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            Add Result
                        </button>
                    </div>
                </form>
            </div>

            <!-- Display Area for Mock Test Results -->
            <div class="overflow-x-auto rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-indigo-600 mb-5 p-4 bg-indigo-50 rounded-t-lg">Your Mock Test Results</h2>
                <table class="min-w-full divide-y divide-gray-200 bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Test Date</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Test Name/ID</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Max Marks</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Your Score</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Time Taken (Min)</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Physics</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Chemistry</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Mathematics</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Total Qs</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Correct</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Incorrect</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Unattempted</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Accuracy (%)</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                            <th scope="col" class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Results will be dynamically inserted here by JavaScript -->
                    </tbody>
                </table>
                <div id="noResultsMessage" class="text-center py-8 text-gray-500 text-lg hidden">
                    No mock test results yet. Add your first result above!
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div id="chartSection" class="hidden">
            <div class="mb-8 p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-indigo-600 mb-5">Performance Trend (Total Score)</h2>
                <div class="relative h-96 w-full">
                    <canvas id="scoreChart"></canvas>
                </div>
                <div id="noChartDataMessage" class="text-center py-4 text-gray-500 text-base hidden">
                    Add more test results to see your performance trend here!
                </div>
            </div>
        </div>

        <!-- Message Box for alerts/confirmations -->
        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h3 id="messageBoxTitle" class="text-lg font-semibold text-gray-900 mb-4"></h3>
                <p id="messageBoxContent" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="messageBoxCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out hidden">Cancel</button>
                    <button id="messageBoxConfirm" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, linkWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =====================================================================
        // IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE
        //
        // Go to your Firebase project settings -> "Your apps" section -> "Web app"
        // Copy the `firebaseConfig` object provided there and paste it below.
        // Make sure to replace the entire placeholder object.
        // =====================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Example: "AIzaSyC0-..."
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", // Example: "my-mock-tracker-12345"
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID" // Example: "1:1234567890:web:abcdef12345"
        };
        // =====================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider(); // Initialize Google Auth Provider

        // Define a fixed application ID for the collection path.
        const APP_ID_FOR_FIRESTORE = "mocktesttracker-pcm";

        // Variables to store current user ID and Firestore unsubscribe function
        let currentUserId = null;
        let unsubscribe = null;
        let mockTestResults = [];
        let scoreChartInstance = null;

        // Get references to HTML elements
        const testForm = document.getElementById('testForm');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingMessage = document.getElementById('loadingMessage');
        const scoreChartCanvas = document.getElementById('scoreChart');
        const noChartDataMessage = document.getElementById('noChartDataMessage');

        // Elements for section toggling
        const homeSection = document.getElementById('homeSection');
        const chartSection = document.getElementById('chartSection');
        const homeNavBtn = document.getElementById('homeNavBtn');
        const chartNavBtn = document.getElementById('chartNavBtn');

        // New Auth UI elements
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');

        // Message Box elements
        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxConfirm = document.getElementById('messageBoxConfirm');
        const messageBoxCancel = document.getElementById('messageBoxCancel');

        /**
         * Displays a custom message box.
         * @param {string} title - The title of the message box.
         * @param {string} message - The content message.
         * @param {boolean} isConfirm - True if it's a confirmation dialog, false for alert.
         * @returns {Promise<boolean>} - Resolves true for OK/Confirm, false for Cancel.
         */
        function showMessageBox(title, message, isConfirm = false) {
            return new Promise((resolve) => {
                messageBoxTitle.textContent = title;
                messageBoxContent.textContent = message;
                messageBoxCancel.classList.toggle('hidden', !isConfirm);
                messageBox.classList.remove('hidden');

                const handleConfirm = () => {
                    messageBox.classList.add('hidden');
                    messageBoxConfirm.removeEventListener('click', handleConfirm);
                    messageBoxCancel.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    messageBox.classList.add('hidden');
                    messageBoxConfirm.removeEventListener('click', handleConfirm);
                    messageBoxCancel.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                messageBoxConfirm.addEventListener('click', handleConfirm);
                messageBoxCancel.addEventListener('click', handleCancel);
            });
        }

        /**
         * Toggles the visibility of sections and updates navigation button styles.
         * @param {string} sectionId - The ID of the section to show ('homeSection' or 'chartSection').
         */
        function showSection(sectionId) {
            if (sectionId === 'homeSection') {
                homeSection.classList.remove('hidden');
                chartSection.classList.add('hidden');
                homeNavBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                homeNavBtn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                chartNavBtn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                chartNavBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            } else if (sectionId === 'chartSection') {
                homeSection.classList.add('hidden');
                chartSection.classList.remove('hidden');
                homeNavBtn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                homeNavBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                chartNavBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                chartNavBtn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                // Ensure chart is rendered/updated when navigating to chart section
                const sortedResultsForChart = [...mockTestResults].sort((a, b) => new Date(a.testDate) - new Date(b.testDate));
                updateScoreChart(sortedResultsForChart);
            }
        }

        // Add event listeners for navigation buttons
        homeNavBtn.addEventListener('click', () => showSection('homeSection'));
        chartNavBtn.addEventListener('click', () => showSection('chartSection'));


        /**
         * Calculates the percentage score.
         * @param {number} score - The student's score.
         * @param {number} maxMarks - The maximum possible marks.
         * @returns {string} - The percentage formatted as a string (e.g., "75.00%").
         */
        function calculatePercentage(score, maxMarks) {
            if (maxMarks === 0 || isNaN(score) || isNaN(maxMarks)) return '0.00%';
            return ((score / maxMarks) * 100).toFixed(2) + '%';
        }

        /**
         * Calculates the accuracy percentage.
         * @param {number} correct - Number of correct answers.
         * @param {number} incorrect - Number of incorrect answers.
         * @returns {string} - The accuracy percentage formatted as a string (e.g., "80.00%").
         */
        function calculateAccuracy(correct, incorrect) {
            const attempted = correct + incorrect;
            if (attempted === 0 || isNaN(correct) || isNaN(incorrect)) return '0.00%';
            return ((correct / attempted) * 100).toFixed(2) + '%';
        }

        /**
         * Renders all mock test results into the table. This function is called
         * whenever data changes in Firestore.
         */
        function renderResults() {
            resultsTableBody.innerHTML = ''; // Clear existing rows

            if (mockTestResults.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
            }

            // Sort results by date in descending order for the table (most recent first)
            const sortedResultsForTable = [...mockTestResults].sort((a, b) => new Date(b.testDate) - new Date(a.testDate));

            sortedResultsForTable.forEach((result) => {
                const row = resultsTableBody.insertRow();
                row.className = 'hover:bg-gray-50'; // Add hover effect to rows

                // Create cells and populate with data
                row.insertCell().textContent = result.testDate;
                row.insertCell().textContent = result.testName;
                row.insertCell().textContent = result.maxMarks;
                row.insertCell().textContent = result.yourScore;
                row.insertCell().textContent = result.percentage; // Already formatted
                row.insertCell().textContent = result.rank || '-'; // Display '-' if no rank
                row.insertCell().textContent = result.timeTaken || '-';
                row.insertCell().textContent = result.physicsScore || '-'; // Physics Score
                row.insertCell().textContent = result.chemistryScore || '-'; // Chemistry Score
                row.insertCell().textContent = result.mathScore || '-'; // Mathematics Score
                row.insertCell().textContent = result.totalQuestions || '-';
                row.insertCell().textContent = result.correctAnswers || '-';
                row.insertCell().textContent = result.incorrectAnswers || '-';
                row.insertCell().textContent = result.unattemptedQuestions || '-';
                row.insertCell().textContent = result.accuracy; // Already formatted
                row.insertCell().textContent = result.remarks || '-';

                // Add Actions cell with Edit and Delete buttons
                const actionsCell = row.insertCell();
                actionsCell.className = 'flex flex-col sm:flex-row space-y-1 sm:space-y-0 sm:space-x-2 py-2';

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 ease-in-out';
                editButton.onclick = () => editResult(result.id); // Use Firestore document ID for editing

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'px-3 py-1 text-sm bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150 ease-in-out';
                deleteButton.onclick = () => deleteResult(result.id); // Use Firestore document ID for deleting

                actionsCell.appendChild(editButton);
                actionsCell.appendChild(deleteButton);
            });
        }

        /**
         * Updates the Chart.js graph with the latest mock test results.
         * @param {Array} data - The sorted array of mock test results.
         */
        function updateScoreChart(data) {
            // Only update chart if the chart section is currently visible
            if (chartSection.classList.contains('hidden')) {
                return;
            }

            if (data.length < 2) { // Need at least two points to draw a meaningful line
                if (scoreChartInstance) {
                    scoreChartInstance.destroy(); // Destroy existing chart if not enough data
                    scoreChartInstance = null;
                }
                noChartDataMessage.classList.remove('hidden');
                scoreChartCanvas.classList.add('hidden');
                return;
            } else {
                noChartDataMessage.classList.add('hidden');
                scoreChartCanvas.classList.remove('hidden');
            }

            const labels = data.map(result => result.testDate);
            const scores = data.map(result => result.yourScore);
            const maxMarks = data.map(result => result.maxMarks);

            // Determine the maximum possible score across all tests for chart scaling
            const overallMaxScore = Math.max(...maxMarks);

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Your Total Score',
                    data: scores,
                    borderColor: 'rgb(99, 102, 241)', // Tailwind indigo-500
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    fill: true,
                    tension: 0.3, // Smooth the line
                    pointBackgroundColor: 'rgb(99, 102, 241)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(99, 102, 241)'
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false, // Allow canvas to fill parent container
                plugins: {
                    title: {
                        display: true,
                        text: 'Total Score Trend Over Time',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        color: '#334155'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + ' / ' + data[context.dataIndex].maxMarks;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category', // For date strings
                        title: {
                            display: true,
                            text: 'Test Date',
                            color: '#475569'
                        },
                        ticks: {
                            color: '#64748b'
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Score',
                            color: '#475569'
                        },
                        min: 0,
                        max: overallMaxScore > 0 ? overallMaxScore + 50 : 300, // Adjust max for better visual
                        ticks: {
                            color: '#64748b'
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        }
                    }
                }
            };

            if (scoreChartInstance) {
                // Update existing chart
                scoreChartInstance.data = chartData;
                scoreChartInstance.options = chartOptions; // Update options too
                scoreChartInstance.update();
            } else {
                // Create new chart
                const ctx = scoreChartCanvas.getContext('2d');
                scoreChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: chartOptions
                });
            }
        }


        // Variable to hold the ID of the result being edited
        let editingResultId = null;

        /**
         * Handles the submission of the form to add a new test result or update an existing one.
         * @param {Event} event - The form submission event.
         */
        testForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            if (!currentUserId) {
                showMessageBox('Error', 'Not authenticated. Please wait for authentication to complete or sign in.', false);
                return;
            }

            // Get values from form inputs
            const testDate = document.getElementById('testDate').value;
            const testName = document.getElementById('testName').value;
            const maxMarks = parseFloat(document.getElementById('maxMarks').value);
            const yourScore = parseFloat(document.getElementById('yourScore').value);
            const rank = document.getElementById('rank').value ? parseInt(document.getElementById('rank').value) : null;
            const timeTaken = document.getElementById('timeTaken').value ? parseInt(document.getElementById('timeTaken').value) : null;
            const physicsScore = document.getElementById('physicsScore').value ? parseFloat(document.getElementById('physicsScore').value) : null;
            const chemistryScore = document.getElementById('chemistryScore').value ? parseFloat(document.getElementById('chemistryScore').value) : null;
            const mathScore = document.getElementById('mathScore').value ? parseFloat(document.getElementById('mathScore').value) : null;
            const totalQuestions = document.getElementById('totalQuestions').value ? parseInt(document.getElementById('totalQuestions').value) : null;
            const correctAnswers = document.getElementById('correctAnswers').value ? parseInt(document.getElementById('correctAnswers').value) : null;
            const incorrectAnswers = document.getElementById('incorrectAnswers').value ? parseInt(document.getElementById('incorrectAnswers').value) : null;
            const unattemptedQuestions = document.getElementById('unattemptedQuestions').value ? parseInt(document.getElementById('unattemptedQuestions').value) : null;
            const remarks = document.getElementById('remarks').value;

            // Calculate derived values
            const percentage = calculatePercentage(yourScore, maxMarks);
            const accuracy = calculateAccuracy(correctAnswers, incorrectAnswers);

            const resultData = {
                testDate, testName, maxMarks, yourScore, percentage,
                rank, timeTaken, physicsScore, chemistryScore, mathScore,
                totalQuestions, correctAnswers, incorrectAnswers, unattemptedQuestions,
                accuracy, remarks,
                timestamp: new Date() // Add a timestamp for potential future sorting/tracking
            };

            try {
                if (editingResultId !== null) {
                    // Update existing result in Firestore
                    const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${currentUserId}/mockTestResults`, editingResultId);
                    await updateDoc(docRef, resultData);
                    showMessageBox('Success', 'Mock test result updated successfully!', false);
                } else {
                    // Add new result to Firestore
                    await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${currentUserId}/mockTestResults`), resultData);
                    showMessageBox('Success', 'Mock test result added successfully!', false);
                }
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showMessageBox('Error', `Failed to save result: ${e.message}`, false);
            } finally {
                editingResultId = null; // Reset editing state
                document.querySelector('button[type="submit"]').textContent = 'Add Result'; // Change button text back
                testForm.reset(); // Clear the form
            }
        });

        /**
         * Populates the form with existing data for editing.
         * @param {string} id - The Firestore document ID of the result to edit.
         */
        function editResult(id) {
            const resultToEdit = mockTestResults.find(result => result.id === id);
            if (!resultToEdit) {
                showMessageBox('Error', 'Result not found for editing.', false);
                return;
            }

            // Set the editing state
            editingResultId = id;
            document.querySelector('button[type="submit"]').textContent = 'Update Result'; // Change button text

            // Populate the form fields with the existing data
            document.getElementById('testDate').value = resultToEdit.testDate;
            document.getElementById('testName').value = resultToEdit.testName;
            document.getElementById('maxMarks').value = resultToEdit.maxMarks;
            document.getElementById('yourScore').value = resultToEdit.yourScore;
            document.getElementById('rank').value = resultToEdit.rank || '';
            document.getElementById('timeTaken').value = resultToEdit.timeTaken || '';
            document.getElementById('physicsScore').value = resultToEdit.physicsScore || '';
            document.getElementById('chemistryScore').value = resultToEdit.chemistryScore || '';
            document.getElementById('mathScore').value = resultToEdit.mathScore || '';
            document.getElementById('totalQuestions').value = resultToEdit.totalQuestions || '';
            document.getElementById('correctAnswers').value = resultToEdit.correctAnswers || '';
            document.getElementById('incorrectAnswers').value = resultToEdit.incorrectAnswers || '';
            document.getElementById('unattemptedQuestions').value = resultToEdit.unattemptedQuestions || '';
            document.getElementById('remarks').value = resultToEdit.remarks || '';
        }

        /**
         * Deletes a mock test result from Firestore.
         * @param {string} id - The Firestore document ID of the result to delete.
         */
        async function deleteResult(id) {
            const confirmDelete = await showMessageBox(
                'Confirm Deletion',
                'Are you sure you want to delete this mock test result? This action cannot be undone.',
                true
            );

            if (confirmDelete) {
                try {
                    const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${currentUserId}/mockTestResults`, id);
                    await deleteDoc(docRef);
                    showMessageBox('Success', 'Mock test result deleted successfully!', false);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessageBox('Error', `Failed to delete result: ${e.message}`, false);
                }
            }
        }

        /**
         * Starts the Firestore real-time listener for mock test results.
         * This function is called once the user is authenticated.
         */
        function startFirestoreListener() {
            if (!currentUserId) {
                console.warn("Firestore listener not started: No current user ID.");
                return;
            }

            // Define the collection path for the current user's private data
            const userResultsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${currentUserId}/mockTestResults`);
            const q = query(userResultsCollectionRef);

            // Set up the real-time listener
            unsubscribe = onSnapshot(q, (snapshot) => {
                mockTestResults = []; // Clear current array
                snapshot.forEach((doc) => {
                    // Add document ID along with its data
                    mockTestResults.push({ id: doc.id, ...doc.data() });
                });
                renderResults(); // Re-render the UI with the latest data for the table
                // Sort results by date in ascending order for the chart (oldest first)
                const sortedResultsForChart = [...mockTestResults].sort((a, b) => new Date(a.testDate) - new Date(b.testDate));
                updateScoreChart(sortedResultsForChart); // Update the chart with the latest data
                loadingMessage.classList.add('hidden'); // Hide loading message once data is loaded
            }, (error) => {
                console.error("Error fetching documents from Firestore: ", error);
                showMessageBox('Data Load Error', `Failed to load test results: ${error.message}`, false);
                loadingMessage.classList.add('hidden'); // Hide loading message even on error
            });
        }

        // --- Google Sign-In and Sign-Out Logic ---

        googleSignInBtn.addEventListener('click', async () => {
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    // If currently anonymous, link the anonymous account to Google
                    const result = await linkWithPopup(auth.currentUser, googleProvider);
                    console.log("Anonymous account linked to Google:", result.user);
                    showMessageBox('Success', `Successfully linked anonymous account to Google: ${result.user.displayName || result.user.email}`, false);
                } else {
                    // If not signed in or not anonymous, sign in directly with Google
                    const result = await signInWithPopup(auth, googleProvider);
                    console.log("Signed in with Google:", result.user);
                    showMessageBox('Success', `Successfully signed in with Google: ${result.user.displayName || result.user.email}`, false);
                }
            } catch (error) {
                console.error("Error during Google Sign-In or linking:", error);
                let errorMessage = "Failed to sign in with Google.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google Sign-In popup was closed. Please try again.";
                } else if (error.code === 'auth/credential-already-in-use') {
                    errorMessage = "This Google account is already linked to another user. Please sign in with that account.";
                } else if (error.message) {
                    errorMessage += ` ${error.message}`;
                }
                showMessageBox('Sign-In Error', errorMessage, false);
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessageBox('Success', 'You have been signed out.', false);
                // After signing out, the onAuthStateChanged listener will trigger and re-sign in anonymously
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageBox('Sign-Out Error', `Failed to sign out: ${error.message}`, false);
            }
        });

        // Handle Firebase Authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in (either anonymously or via Google)
                currentUserId = user.uid;
                userIdDisplay.textContent = `User ID: ${user.displayName || user.email || user.uid} (Type: ${user.isAnonymous ? 'Anonymous' : 'Google'})`;

                // Show/hide sign-in/sign-out buttons based on auth state
                googleSignInBtn.classList.add('hidden'); // Hide sign-in button if already signed in
                signOutBtn.classList.remove('hidden');

                // Start listening to Firestore for data
                if (unsubscribe) unsubscribe(); // Unsubscribe from any previous listener
                startFirestoreListener();
            } else {
                // User is signed out or not yet signed in.
                currentUserId = null;
                userIdDisplay.textContent = 'Authenticating...';
                loadingMessage.classList.remove('hidden');
                googleSignInBtn.classList.remove('hidden'); // Show sign-in button
                signOutBtn.classList.add('hidden');

                // If no user, attempt anonymous sign-in to ensure data persistence for non-logged-in users
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Error signing in anonymously:", anonError);
                    showMessageBox('Authentication Error', `Failed to authenticate anonymously: ${anonError.message}. Please try refreshing the page.`, false);
                    loadingMessage.classList.add('hidden');
                }
            }
        });

        // Cleanup: On window unload, unsubscribe from Firestore listener to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
                console.log("Firestore listener unsubscribed.");
            }
        });

        // Initialize the view to the Home section when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            showSection('homeSection');
        });
    </script>
</body>
</html>

